import path from 'path';
import { readFileSync } from 'fs';
import { walk } from 'estree-walker';
import { minify } from 'html-minifier';

const htmlMinifierOptions = {
  collapseWhitespace: true,
  collapseInlineTagWhitespace: true,
  includeAutoGeneratedTags: false,
  minifyCSS: {
    format: {
      wrapAt: 200
    }
  },
  removeComments: true,
  maxLineLength: 210
};

export default function htmlTemplateLoader() {

	return {

    name: 'html-template',

    transform(code, id) {

      const ast = this.parse(code);
      let _code = code;
      const addWatchFile = this.addWatchFile;

      walk(ast, {
        enter: function(node) {
          if (node.type === 'ImportDeclaration') {
            // @ts-expect-error
            const { specifiers, source, start, end } = node;
            if (source.value.slice(-5) === '.html') {
              const filepath = path.resolve(path.dirname(id), source.value);
              addWatchFile(filepath);
              const dirname = path.dirname(id);
              const file = path.resolve(dirname, source.value);
              const content = readFileSync(file).toString();
              const minified = minify(content, htmlMinifierOptions);
              const html = `process.env.NODE_ENV === 'production' \n? \`${minified}\` \n: \`${content}\n\``;
              _code = _code.slice(0, start) + `import HTMLTemplate from '@internals/HTMLTemplate';\n var ${specifiers[0].local.name} = new HTMLTemplate(${html});\n` + _code.slice(end);
            }
          }
				},
			});

      return {
        code: _code
      };
    }

	};
}